<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>My Punky Cinema with Mantras</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Vast+Shadow&display=swap" rel="stylesheet" />
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0; padding: 0; background: #111; /* dark background for cinema */
  font-family: 'Press Start 2P', cursive;
  color: #eee;
  overflow: hidden;
  border: 20px solid #222;
  box-sizing: border-box;
}

/* Overlay for flickering effect */
body::before {
  content: "";
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: repeating-linear-gradient(
    0deg,
    rgba(255,255,255,0.02),
    rgba(255,255,255,0.02) 1px,
    transparent 1px,
    transparent 3px
  );
  pointer-events: none;
  z-index: 2;
}

/* Floating bubbles container (for mantra words) */
#bubblesContainer {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 1; /* behind main content */
  pointer-events: none; /* so clicks pass through */
  overflow: hidden;
}

/* Main content styles */
.content {
  position: relative; z-index: 3;
  max-width: 900px; margin: auto; padding: 20px; display:flex; flex-direction:column; align-items:center;
}

/* User info & auth styling (same as before) */
#user-avatar { /* ... */ }
#avatar-img { /* ... */ }
#avatar-title { /* ... */ }
#auth-buttons { /* ... */ }
button { /* ... */ }
#auth-form { /* ... */ }
#main-content { /* ... */ }
#chat-header { /* ... */ }
#loading { /* ... */ }
#chat { /* ... */ }
.menu { /* ... */ }
#synopsis { /* ... */ }

/* Mantra input panel styling */
#mantraPanel {
  margin-top: 20px; width: 100%; max-width: 600px; display:flex; flex-direction:column; align-items:center; background:#222; padding:10px; border-radius:8px; box-shadow: inset 4px 4px 8px #000, inset -4px -4px 8px #555; }
#mantraInput {
  width: 70%; padding:8px; border:2px solid #4B0082; border-radius:4px; background:#222; color:#eee; font-family:'Press Start 2P'; font-size:0.8em; margin-bottom:8px;
}
#mantraButtons {
  display:flex; gap:10px; justify-content:center; margin-top:8px;
}
#mantraButtons button {
  padding:8px 12px; background:#4B0082; color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:'Press Start 2P';
}

/* Floating word style */
.floating-word {
  position: absolute;
  font-family:'Vast Shadow'; font-size:1.5em; color:#f0f;
  opacity:0.8;
  white-space:nowrap;
  pointer-events: none;
  user-select:none;
  animation: floatAcross 20s linear forwards;
}
@keyframes floatAcross {
  from { transform: translate(0,0); }
  to { transform: translate(var(--dx), var(--dy)); opacity:0; }
}
</style>
</head>
<body>

<div class="content">
  <!-- User info & auth -->
  <div id="user-avatar">
    <img id="avatar-img" src="officialsticker.png" alt="User Avatar" />
    <div id="avatar-title">Punk Zen</div>
  </div>
  <div id="auth-buttons">
    <button onclick="showSignUp()">Sign Up</button>
    <button onclick="showSignIn()">Log In</button>
  </div>
  <div id="auth-form" style="display:none;">
    <h2>Welcome to the Punk Tribe</h2>
    <input type="text" id="signup-username" placeholder="Choose a username" />
    <input type="email" id="auth-email" placeholder="Email" />
    <input type="password" id="auth-password" placeholder="Password" />
    <button onclick="submitAuth()">Submit</button>
    <button onclick="cancelAuth()">Cancel</button>
    <div id="signup-message"></div>
  </div>
  <!-- Main content (hidden until login) -->
  <div id="main-content" style="display:none;">
    <div id="chat-header">Please log in</div>
    <div id="loading">Loading...</div>
    <div id="chat"></div>
    <div class="menu" id="menu"></div>
    <div id="synopsis"></div>
    <!-- Mantra input panel -->
    <div id="mantraPanel">
      <input type="text" id="mantraInput" placeholder="Enter a good word" />
      <div id="mantraButtons">
        <button onclick="addMantra()">Add Word</button>
        <button onclick="pauseMantras()">Pause</button>
        <button onclick="clearMantras()">Clear</button>
      </div>
    </div>
  </div>
</div>

<!-- Button to toggle mantra bubbles (optional) -->
<!-- Not needed if always active after login, but you can hide/show with JS if needed -->

<!-- Floating bubbles container -->
<div id="bubblesContainer"></div>

<!-- Music controls (hidden initially) -->
<button id="musicIcon" style="display:none;" onclick="toggleMusic()">Music</button>
<div id="musicDrawer" style="display:none;">
  <div>Now Playing: <span id="nowPlaying">-</span></div>
  <button id="music-toggle" onclick="toggleMusic()">Mute</button>
  <audio id="musicPlayer"></audio>
</div>

<script>
const supabaseUrl='https://hwymepujsvfqjkbullaf.supabase.co'; // your URL
const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3eW1lcHVqc3ZmcWprYnVsbGFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDczOTQsImV4cCI6MjA4NDI4MzM5NH0.V6-Cm331IocSXDqe-v6iAZA3TV1STyEHyQI43lcXU_4'; // your API key
window.supabase=supabase.createClient(supabaseUrl,supabaseKey);

let currentUser=null;
let username=null;

// Show auth forms
function showSignUp(){ showAuthForm('signup'); }
function showSignIn(){ showAuthForm('signin'); }
function cancelAuth(){ document.getElementById('auth-form').style.display='none'; document.getElementById('auth-buttons').style.display='flex'; }

// Show form
function showAuthForm(mode){
  document.getElementById('auth-form').style.display='flex';
  document.getElementById('auth-buttons').style.display='none';
  document.querySelector('#auth-form h2').innerText=mode==='signup'?'Sign Up':'Log In';
  document.getElementById('signup-message').innerText='';
  document.getElementById('signup-username').style.display=mode==='signup'?'block':'none';
}

// Submit auth
async function submitAuth(){
  const email=document.getElementById('auth-email').value;
  const password=document.getElementById('auth-password').value;
  const usernameInput=document.getElementById('signup-username').value.trim();

  if(!email || !password){ alert('Enter email and password'); return; }
  if(document.querySelector('#auth-form h2').innerText==='Sign Up' && !usernameInput){ alert('Choose a username'); return; }

  if(document.querySelector('#auth-form h2').innerText==='Sign Up'){
    // Sign up
    const { data, error }=await supabase.auth.signUp({ email, password });
    if(error){ alert(error.message); return; }
    // Save profile
    await supabase.from('profiles').upsert({ id: data.user.id, username: usernameInput });
    alert('Check your email to confirm your account.');
    cancelAuth();
  } else {
    // Sign in
    const { data, error }=await supabase.auth.signInWithPassword({ email, password });
    if(error){ alert(error.message); return; }
    currentUser=data.user;
    await fetchAndSetUsername();
    // Show mantra panel and music
    document.getElementById('musicIcon').style.display='block';
    document.getElementById('musicDrawer').style.display='block';
    document.getElementById('main-content').style.display='block';
    updateGreeting();
    document.getElementById('auth-form').style.display='none';
    document.getElementById('auth-buttons').style.display='none';
  }
}

// Fetch username
async function fetchAndSetUsername(){
  if(!currentUser) return;
  const { data }=await supabase.from('profiles').select('username').eq('id',currentUser.id).single();
  username=data?.username || currentUser.email;
}

// Greeting
function updateGreeting(){
  document.getElementById('chat-header').innerText=`Welcome, ${username}!`;
  document.getElementById('loading').style.display='none';
  document.getElementById('chat').innerHTML=`<p>Hello ${username}! Welcome to your punk cinema!</p>`;
}

// Menu setup
const menuItems=[
  { title:'ABOUT',link:'https://en.wikipedia.org/wiki/Punk_rock',desc:'Learn about punk' },
  { title:'MUSIC',link:'https://www.punknews.org/',desc:'Discover punk tunes' },
  { title:'SHOP',link:'https://punkclothing.com/',desc:'Get punk fashion' },
  { title:'BLOG',link:'https://punkblog.com/',desc:'Read punk stories' }
];
const menuDiv=document.getElementById('menu');
menuItems.forEach(i => {
  const m=document.createElement('div');
  m.className='menu-item';
  m.innerText=i.title;
  m.onclick=()=>{ document.getElementById('synopsis').innerHTML=`<p>${i.desc}</p><a href="${i.link}" target="_blank" style="color:#eee;">Visit</a>`; }
  menuDiv.appendChild(m);
});

// Mantras floating
const bubblesContainer=document.getElementById('bubblesContainer');
const mantraWords=[];
let mantraInterval=null;

function addMantra(){
  const word=document.getElementById('mantraInput').value.trim();
  if(!word){ alert('Enter a word'); return; }
  createFloatingWord(word);
  document.getElementById('mantraInput').value='';
}

// Create floating word element
function createFloatingWord(text){
  const el=document.createElement('div');
  el.className='floating-word';
  el.innerText=text;
  // random start position
  el.style.top=Math.random()*80+'%';
  el.style.left='0%';
  // random direction
  const angle=Math.random()*360;
  const distance=100+Math.random()*200; // px
  const dx=Math.cos(angle*Math.PI/180)*distance+'px';
  const dy=Math.sin(angle*Math.PI/180)*distance+'px';
  el.style.setProperty('--dx',dx);
  el.style.setProperty('--dy',dy);
  bubblesContainer.appendChild(el);

  // Animate with loop
  animateWord(el);
}

// Animate floating word
function animateWord(el){
  // Animate using CSS keyframes
  el.animate([
    { transform: 'translate(0,0)', opacity: 0.8 },
    { transform: `translate(var(--dx), var(--dy))`, opacity: 0 }
  ], {
    duration: 20000,
    iterations: 1,
    easing: 'linear'
  }).onfinish=()=>{ 
    // Remove after animation
    if(el.parentNode) el.parentNode.removeChild(el);
  };
}

// Add word button handler
window.addMantra=function(){
  addMantra();
}

// Pause all floating
function pauseMantras(){
  // Remove all animations, stop new ones
  // Could store references if needed
  // For simplicity, just stop adding
  clearInterval(mantraInterval);
}

// Clear all bubbles
function clearMantras(){
  bubblesContainer.innerHTML='';
}

</script>
</body>
</html>
