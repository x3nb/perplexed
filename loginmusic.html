<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>My Punky Community</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Vast+Shadow&display=swap" rel="stylesheet" />
<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  padding: 0;
  background: #fff; /* white background for paper aesthetic */
  font-family: 'Press Start 2P', cursive;
  color: #000;
  overflow: hidden;
}

/* Floating shapes background for aesthetic */
.background-shapes { position: absolute; top:0; left:0; width:100%; height:100%; overflow:hidden; z-index:0; }
.shape {
  position: absolute; border-radius:50%; animation:float 10s infinite linear;
}
@keyframes float {
  0% { transform:translateY(0) rotate(0deg);}
  100% { transform:translateY(-100vh) rotate(360deg);}
}

/* Container for main content, centered */
.container {
  position: relative; z-index: 1; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:20px;
}

/* Avatar + title with layered shading for papercut effect */
#user-avatar {
  display:flex; flex-direction:column; align-items:center; margin:20px auto;
}
#avatar-img {
  width:100px; height:100px; border-radius:50%; border: 3px solid #4B0082;
  box-shadow: inset 4px 4px 8px #666, inset -4px -4px 8px #999;
  background:#fff;
}
#avatar-title {
  font-family: 'Vast Shadow', cursive; color:#4B0082; margin-top:10px; font-size:1.2em; text-shadow:2px 2px #999;
}

/* Buttons for auth */
#auth-buttons {
  margin-top:20px; display:flex; justify-content:center; gap:15px;
}
#auth-buttons button {
  margin:0; padding:10px 20px; background:#fff; color:#4B0082; border:2px solid #4B0082; cursor:pointer; font-family:'Press Start 2P',cursive;
  border-radius:5px;
  box-shadow: inset 4px 4px 8px #666, inset -4px -4px 8px #999;
}

/* Auth form with layered papercut style, including username input for sign-up */
#auth-form {
  display:none; margin-top:20px; width:90%; max-width:400px;
}
.auth-box {
  background: #fff;
  border: 2px solid #4B0082;
  padding: 20px;
  border-radius: 10px;
  box-shadow: inset 4px 4px 8px #666, inset -4px -4px 8px #999;
  display:flex; flex-direction:column; align-items:center;
}
.auth-box h2 {
  font-family:'Vast Shadow', cursive; font-size:1.2em; margin-bottom:10px; color:#4B0082;
}
.auth-box input {
  width:90%;
  margin:10px 0;
  padding:10px;
  background:#fff;
  border:2px solid #4B0082;
  border-radius:5px;
  font-family:'Press Start 2P',cursive;
  box-shadow: inset 2px 2px 4px #666, inset -2px -2px 4px #999;
}
.auth-box button {
  margin-top:10px;
  padding:10px 20px;
  background:#fff;
  color:#4B0082;
  border:2px solid #4B0082;
  cursor:pointer;
  border-radius:5px;
  box-shadow: inset 2px 2px 4px #666, inset -2px -2px 4px #999;
  font-family:'Press Start 2P',cursive;
}

/* Main content styled with papercut aesthetic */
#main-content {
  display:none; margin-top:20px; width:100%; max-width:700px; text-align:center;
}
#chat-header {
  font-family:'Vast Shadow', cursive; font-size:1.2em; margin-bottom:10px; color:#4B0082;
}
#loading-indicator {
  color:#4B0082; margin-bottom:10px;
}
#chat {
  background: rgba(255,255,255,0.6);
  padding:10px;
  border-radius:8px;
  min-height:100px;
  margin:auto;
  box-shadow: inset 4px 4px 8px #666, inset -4px -4px 8px #999;
  font-family:'Press Start 2P', cursive; font-size:0.9em; color:#000;
}
#menu {
  display:flex; flex-wrap:wrap; justify-content:center; margin-top:20px; gap:10px;
}
.menu-item {
  cursor:pointer; padding:10px 15px; background:#fff; color:#4B0082; border-radius:5px; font-family:'Press Start 2P',cursive; font-size:0.8em;
  border:2px solid #4B0082;
  box-shadow: inset 2px 2px 4px #666, inset -2px -2px 4px #999;
}
#synopsis {
  margin-top:20px; max-width:600px; margin-left:auto; margin-right:auto; text-align:left; padding:10px; background: rgba(255,255,255,0.1); border-radius:8px; box-shadow: inset 4px 4px 8px #666, inset -4px -4px 8px #999;
  color:#000; font-family:'Press Start 2P', cursive; font-size:0.9em;
}

/* Optional notes styling if used later */
.note {
  width:140px; min-height:110px; padding:10px;
  background:#d3d3d3; color:#222; border-radius:8px;
  box-shadow: inset 4px 4px 8px #666, inset -4px -4px 8px #999;
  font-size:0.6em; transform: rotate(var(--r));
}
#noteInput {
  width:90%; padding:10px; margin-top:20px; border:2px dashed #4B0082; border-radius:5px;
  background:#fff; box-shadow: inset 2px 2px 4px #666, inset -2px -2px 4px #999; font-family:'Press Start 2P', cursive;
}

/* Music drawer styles */
#musicDrawer {
  position: fixed;
  bottom: 0;
  right: -300px; /* hidden off-screen initially */
  width: 300px;
  height: 200px;
  background: #fff;
  border-top: 4px solid #4B0082;
  box-shadow: 0px -2px 10px rgba(0,0,0,0.3);
  border-radius-top-left:10px;
  transition: right 0.3s ease;
  padding: 10px;
  display:flex; flex-direction:column; align-items:center; justify-content:space-around;
  z-index: 999;
}
#musicDrawer.open { right:0; }
#music-controls {
  display:flex; gap:10px; width:100%; justify-content:center;
}
button#music-toggle {
  padding:8px 12px;
  border:none;
  background:#4B0082;
  color:#fff;
  border-radius:5px;
  cursor:pointer;
  font-family:'Press Start 2P', cursive;
}
</style>
</head>
<body>

<div class="background-shapes" id="shapes"></div>

<div class="container">
  <!-- Avatar + title -->
  <div id="user-avatar">
    <img id="avatar-img" src="officialsticker.png" alt="User Avatar" />
    <div id="avatar-title">Punk Zen</div>
  </div>

  <!-- Auth buttons -->
  <div id="auth-buttons">
    <button onclick="showSignUp()">Sign Up</button>
    <button onclick="showSignIn()">Log In</button>
  </div>

  <!-- Auth form -->
  <div class="auth-box" id="auth-form" style="display:none;">
    <h2>Welcome to the Punk Tribe</h2>
    <input type="text" id="signup-username" placeholder="Choose a username" />
    <input type="email" id="auth-email" placeholder="Email" />
    <input type="password" id="auth-password" placeholder="Password" />
    <button onclick="submitAuth()">Submit</button>
    <button onclick="cancelAuth()">Cancel</button>
    <div id="signup-message"></div>
  </div>

  <!-- Main content -->
  <div id="main-content">
    <div class="chat-header" id="chat-header">Loading...</div>
    <div class="loading" id="loading-indicator">Connecting to the punk chat...</div>
    <div id="chat" class="greet"></div>
    <div class="menu" id="menu"></div>
    <div id="synopsis"></div>
  </div>
</div>

<!-- Music icon, hidden until login -->
<button id="musicIcon" style="display:none; position:fixed;bottom:10px;left:10px;z-index:9999;padding:10px 15px;border:none;border-radius:5px;background:#4B0082;color:#fff;font-family:'Press Start 2P';cursor:pointer;">Music</button>

<!-- Music drawer, hidden until login -->
<div id="musicDrawer" style="display:none; position:fixed; bottom:0; right:-300px; width:300px; height:200px; background:#fff; border-top:4px solid #4B0082; box-shadow:0px -2px 10px rgba(0,0,0,0.3); border-radius-top-left:10px; transition:right 0.3s ease; padding:10px; display:flex; flex-direction:column; align-items:center; justify-content:space-around; z-index:999;">
  <div>Now Playing: <span id="nowPlaying">-</span></div>
  <div id="musicControls" style="display:flex; gap:10px; margin-top:10px;">
    <button id="music-toggle" onclick="toggleMusic()">Mute</button>
  </div>
  <audio id="musicPlayer" controls style="width:100%; margin-top:10px; display:none;"></audio>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Generate floating shapes background
  const shapeCount=20;
  const shapesContainer=document.getElementById('shapes');
  for(let i=0;i<shapeCount;i++){
    const shape=document.createElement('div');
    shape.className='shape';
    shape.style.width=(10+Math.random()*30)+'px';
    shape.style.height=shape.style.width;
    shape.style.top=Math.random()*100+'%';
    shape.style.left=Math.random()*100+'%';
    shape.style.background='linear-gradient(45deg,#4B0082,#999)';
    shape.style.transform=`rotate(${Math.random()*360}deg)`;
    shape.style.animationDuration=(10+Math.random()*20)+'s';
    shapesContainer.appendChild(shape);
  }

  // Initialize Supabase
  const supabaseUrl='https://hwymepujsvfqjkbullaf.supabase.co'; // your URL
  const supabaseKey='removed for security'; // your key
  window.supabase=supabase.createClient(supabaseUrl, supabaseKey);

  window.authMode=null;
  window.currentUser=null;
  window.username=null;
  let musicQueue=[]; 
  let currentSongIndex=0;
  let isPlaying=false;

  // Show sign up or sign in form
  window.showSignUp=()=>{ window.authMode='signup'; showForm(); }
  window.showSignIn=()=>{ window.authMode='signin'; showForm(); }
  window.cancelAuth=()=>{
    document.getElementById('auth-form').style.display='none'; 
    document.getElementById('auth-buttons').style.display='flex'; 
    document.getElementById('signup-message').innerText=''; 
    window.authMode=null; 
  }

  function showForm() {
    document.getElementById('auth-form').style.display='block';
    document.getElementById('auth-buttons').style.display='none';
    document.getElementById('signup-message').innerText='';
  }

  // Submit auth
  window.submitAuth=async ()=> {
    const email=document.getElementById('auth-email').value;
    const password=document.getElementById('auth-password').value;
    const username=document.getElementById('signup-username').value.trim();
    if(!email||!password){ alert('Enter email and password'); return; }
    if(!username){ alert('Choose a username'); return; }

    if(window.authMode==='signup'){
      const { data, error }=await supabase.auth.signUp({ email, password });
      if(error){ alert('Sign-up error: '+error.message); return; }

      // Save username
      const userId=data.user.id;
      await supabase.from('profiles').upsert({ id:userId, username:username });
      
      document.getElementById('signup-message').innerText='Sign-up successful! Check your email for confirmation.';
      document.getElementById('auth-buttons').innerHTML='<button onclick="showSignIn()">Log In</button>';
      document.getElementById('auth-buttons').style.display='flex';
      document.getElementById('auth-form').style.display='none';

    } else if(window.authMode==='signin'){
      const { data, error }=await supabase.auth.signInWithPassword({ email, password });
      if(error){
        if(error.message.includes('Email not confirmed')){
          alert('Your email is not confirmed yet. Check your inbox or request a new confirmation.');
        } else {
          alert('Sign-in error: '+error.message);
        }
        return;
      }
      // Login success
      window.currentUser=data.user;
      // Fetch username
      await fetchAndSetUsername();
      // Show the music icon and drawer now
      document.getElementById('musicIcon').style.display='block';
      document.getElementById('musicDrawer').style.display='flex';

      document.getElementById('auth-form').style.display='none';
      document.getElementById('auth-buttons').style.display='none';
      document.getElementById('main-content').style.display='block';
      showGreeting();
    }
  };

  async function fetchAndSetUsername() {
    if (window.currentUser) {
      const { data }=await supabase
        .from('profiles')
        .select('username')
        .eq('id', window.currentUser.id)
        .single();
      window.username=data?.username || window.currentUser.email;
    }
  }

  function showGreeting() {
    if(!window.username) fetchAndSetUsername().then(()=> {
      updateGreeting();
    });
    else {
      updateGreeting();
    }
  }

  function updateGreeting() {
    const header=document.getElementById('chat-header');
    header.innerText=`Welcome, ${window.username}!`;
    document.getElementById('loading-indicator').style.display='none';

    const chatDiv=document.getElementById('chat');
    chatDiv.innerHTML=`<p>Hello ${window.username}! Welcome to your punky community!</p>`;
    chatDiv.style.display='block';
  }

  // Load profile avatar
  async function loadProfile() {
    if (window.currentUser) {
      const { data }=await supabase
        .from('profiles')
        .select('avatar_url, username')
        .eq('id', window.currentUser.id)
        .single();
      document.getElementById('avatar-img').src=data?.avatar_url || 'https://placehold.co/100x100';
    }
  }

  // Upload avatar
  window.uploadAvatar=async (e)=>{
    const file=e.target.files[0];
    const path=`${window.currentUser.id}.png`;
    await supabase.storage.from('avatars').upload(path, file,{ upsert:true });
    const url=supabase.storage.from('avatars').getPublicUrl(path).data.publicUrl;
    await supabase.from('profiles').upsert({ id:window.currentUser.id, avatar_url:url });
    loadProfile();
  }

  // Setup menu
  const menuItems=[
    { title:'ABOUT', synopsis:'Learn about the punky community and its roots.', link:'https://en.wikipedia.org/wiki/Punk_rock' },
    { title:'MUSIC', synopsis:'Discover punk-inspired tunes and playlists.', link:'https://www.punknews.org/' },
    { title:'SHOP', synopsis:'Get punk fashion and accessories.', link:'https://punkclothing.com/' },
    { title:'BLOG', synopsis:'Read stories and updates from the community.', link:'https://punkblog.com/' }
  ];
  const menuContainer=document.getElementById('menu');
  const synopsisDiv=document.getElementById('synopsis');
  menuItems.forEach(item=>{
    const div=document.createElement('div');
    div.className='menu-item';
    div.innerText=item.title;
    div.onclick=()=>{ synopsisDiv.innerHTML=`<p>${item.synopsis}</p><a href="${item.link}" target="_blank" style="color:#f0f;">Visit Link</a>`; };
    menuContainer.appendChild(div);
  });

  // Music setup
  const musicTracks=[
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
    'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
  ];
  const musicPlayer=document.getElementById('musicPlayer');
  const nowPlayingSpan=document.getElementById('nowPlaying');
  let currentTrack=0;
  let isPlaying=false;
  const musicDrawer=document.getElementById('musicDrawer');

  document.getElementById('musicIcon').onclick=()=>{
    musicDrawer.classList.toggle('open');
  };

  function playNext() {
    if(currentTrack>=musicTracks.length) {
      isPlaying=false;
      document.getElementById('music-toggle').innerText='Unmute';
      return;
    }
    nowPlayingSpan.innerText='Track ' + (currentTrack+1);
    musicPlayer.src=musicTracks[currentTrack];
    musicPlayer.style.display='block';
    musicPlayer.play();
    isPlaying=true;
  }

  musicPlayer.onended=()=>{
    currentTrack++;
    playNext();
  };

  window.toggleMusic=()=>{
    if(isPlaying){
      musicPlayer.pause();
      isPlaying=false;
      document.getElementById('music-toggle').innerText='Unmute';
    } else {
      if(currentTrack>=musicTracks.length) { currentTrack=0; }
      playNext();
      document.getElementById('music-toggle').innerText='Mute';
    }
  };
});
</script>
</body>
</html>
